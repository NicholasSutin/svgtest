<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PNG → Vectorized SVG</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #preview { max-width: 300px; border: 1px solid #ccc; margin-top: 10px; }
</style>
</head>
<body>

<h3>Alpha PNG → Vectorized SVG</h3>
<input type="file" id="fileInput" accept="image/png" />
<br>
<label>Alpha Threshold (0.01 - 0.99): <input type="number" id="alpha" min="0.01" max="0.99" step="0.01" value="0.5"></label>
<br><br>
<img id="preview">

<script src="https://unpkg.com/marchingsquares@1.3.0/dist/marchingsquares.min.js"></script>
<script>
const fileInput = document.getElementById("fileInput");
const preview = document.getElementById("preview");

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const alphaThresholdInput = parseFloat(document.getElementById('alpha').value);
  const alphaThreshold = Math.min(Math.max(alphaThresholdInput, 0.01), 0.99) * 255;

  const img = new Image();
  img.src = URL.createObjectURL(file);
  await img.decode();
  preview.src = img.src;

  const canvas = document.createElement("canvas");
  canvas.width = img.width;
  canvas.height = img.height;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0);

  const data = ctx.getImageData(0, 0, img.width, img.height).data;

  // Build binary alpha mask
  const mask = [];
  for (let y = 0; y < img.height; y++) {
    mask[y] = [];
    for (let x = 0; x < img.width; x++) {
      const a = data[(y * img.width + x) * 4 + 3];
      mask[y][x] = a >= alphaThreshold ? 1 : 0;
    }
  }

  // Use Marching Squares to get contour polygons
  const polygons = MarchingSquaresJS.isoContours(mask, 0.5);

  // Convert polygons to SVG paths
  const svgPaths = polygons.map(poly => {
    const d = poly.map(([x,y], i) => i === 0 ? `M${x},${y}` : `L${x},${y}`).join(" ") + " Z";
    return `<path d="${d}" fill="black"/>`;
  }).join("\n");

  const svgContent = `
<svg xmlns="http://www.w3.org/2000/svg" 
     viewBox="0 0 ${img.width} ${img.height}" 
     shape-rendering="crispEdges" fill="black">
  ${svgPaths}
</svg>
  `;

  // Download the SVG
  const blob = new Blob([svgContent], { type: "image/svg+xml" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "vectorized.svg";
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
